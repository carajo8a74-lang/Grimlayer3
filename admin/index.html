<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Decap CMS</title>
  <style>
    html,body{height:100%;margin:0;background:#111;color:#ccc;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px}
    a{color:#6cf;text-decoration:none}
  </style>
  <!-- Netlify Identity widget (login modal) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <!-- Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.3.0/dist/decap-cms.js"></script>
</head>
<body>
  <div class="wrap">
    <div id="cms-root">Loading Admin…</div>
    <a href="./health.html" style="font-size:14px;opacity:.8">Health check</a>
  </div>

  <script>
    // Arranca el widget de Identity (necesario para Git Gateway)
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on('init', user => {
        if (!user) window.netlifyIdentity.on('login', () => window.location.reload());
      });
      window.netlifyIdentity.init({ APIUrl: '/.netlify/identity' });
    }

    // Evita “Loading Admin…” por caché de config.yml
    const bust = 'v=' + Date.now();
    window.CMS_MANUAL_INIT = true;
    fetch('./config.yml?' + bust, { cache: 'no-store' })
      .then(r => r.ok ? r.text() : Promise.reject(new Error('config ' + r.status)))
      .then(yml => {
        const config = window.jsyaml.load(yml);
        window.CMS.init({ config });       // inicia Decap con la config cargada
      })
      .catch(err => {
        document.getElementById('cms-root').textContent = 'Error loading config: ' + err.message;
      });
  </script>

  <!-- jsyaml para parsear YML en el navegador -->
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</body>
</html>
